---
title: "verticalheightandclimateanalysis"
author: "Keely Maynard"
date: "2025-04-25"
output: html_document
---
## Introduction

This document provides the workflow used to analyze the vertical habitat use of Bengal slow lorises in trees across hot, dry, and wet seasons. The code starts from cleaned (centered predictors, interaction terms, and zone IDs created in ArcGIS Pro) and analysis ready seasonal data files: 
- dry_data_height.csv
- hot_data_height.csv
- wet_data_height.csv

These files contain: 
- behavioral category ('beh2')
- individual identifier ('id')
- spatial zone identifiers at 100 m, 200 m, and 300 m scales ('zoneid_100m', 'zoneid_200m', zoneid_300m')
- centered climate predictors ('temp_c', 'Rh_c')
- the interaction between temperature and relative humidity (temp_Rh_c)
- loris height in meters ('animal_height.m')
- time of observation ('time')

These datafiles are avaliable in the GitHub repository associated with this manuscript.
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  include = TRUE,
  message = FALSE,
  warning = FALSE)
knitr::opts_hooks$set(eval= NULL, include = NULL)
continue <- TRUE

#call libraries for use in the whole document
library(lubridate)
library(stringr)
library(brms)
library(bayesplot)
library(ggplot2)
library(patchwork)
library(dplyr)

# Neutralize any hooks that mutate eval/include (prevents '!continue')
knitr::opts_hooks$set(eval    = function(opts) { opts$eval    <- TRUE; opts })
knitr::opts_hooks$set(include = function(opts) { opts$include <- TRUE; opts })
```

## Data Cleaning

```{r Data_import}
#import data

hot_data <- read.csv("hot_data_height.csv")
dry_data <- read.csv("dry_data_height.csv")
wet_data <- read.csv('wet_data_height.csv')
```

##Data Cleaning
```{r Data Cleaning}
#make sure that all characters that are factors are set as factors

hot_data$beh2 <- as.factor(hot_data$beh2) #behavior (4 levels)
dry_data$beh2 <- as.factor(dry_data$beh2)
wet_data$beh2 <- as.factor(wet_data$beh2)

hot_data$id <- as.factor(hot_data$id) #individual id
dry_data$id <- as.factor(dry_data$id)
wet_data$id <- as.factor(wet_data$id)

hot_data$zone_id_100 <- as.factor(hot_data$zone_id_100) #zone id (100m)
dry_data$zoneid_100m <- as.factor(dry_data$zoneid_100m)
wet_data$zoneid_100m <- as.factor(wet_data$zoneid_100m)

hot_data$zone_id_200m <- as.factor(hot_data$zone_id_200m) #zone id (200m)
dry_data$zoneid_200m <- as.factor(dry_data$zoneid_200m)
wet_data$zoneid_200m <- as.factor(wet_data$zoneid_200m)

hot_data$zone_id_300 <- as.factor(hot_data$zone_id_300) #zone id (300m)
dry_data$zoneid_300m <- as.factor(dry_data$zoneid_300m)
wet_data$zoneid_300m <- as.factor(wet_data$zoneid_300m)


#set resting as the reference variable
dry_data$beh2 <- relevel(dry_data$beh2, ref = "re")
hot_data$beh2 <- relevel(hot_data$beh2, ref = "re")
wet_data$beh2 <- relevel(wet_data$beh2, ref = "re")

```
## Time Processing

```{r Time_Processing}

#create a reference time for the start of a night
night_start <- hms("19:00:00")

#add seconds to any time periods that are missing seconds
wet_data$time_clean <- ifelse(
  str_detect(wet_data$Time, "^\\d{1,2}:\\d{2}$"),
  paste0(wet_data$Time, ":00"),
  wet_data$Time
)

dry_data$time_clean <- ifelse(
  str_detect(dry_data$Time, "^\\d{1,2}:\\d{2}$"),
  paste0(dry_data$Time, ":00"),
  dry_data$Time
)

hot_data$time_clean <- ifelse(
  str_detect(hot_data$Time, "^\\d{1,2}:\\d{2}$"),
  paste0(hot_data$Time, ":00"),
  hot_data$Time
)

# Parse the time correctly
dry_data$time_clean <- hms(dry_data$time_clean)
hot_data$time_clean <- hms(hot_data$time_clean)
wet_data$time_clean <- hms(wet_data$time_clean)

#How many minutes since the set night start
dry_data$time_minutes <- as.numeric(dry_data$time_clean - night_start) / 60
wet_data$time_minutes <- as.numeric(wet_data$time_clean - night_start) / 60
hot_data$time_minutes <- as.numeric(hot_data$time_clean - night_start) / 60

#for any times that come after midnight we need to handle the negative values
dry_data$time_minutes <- ifelse(
  dry_data$time_minutes < 0,
  dry_data$time_minutes + 1440,
  dry_data$time_minutes
)

hot_data$time_minutes <- ifelse(
  hot_data$time_minutes < 0,
  hot_data$time_minutes + 1440,
  hot_data$time_minutes
)

wet_data$time_minutes <- ifelse(
  wet_data$time_minutes < 0,
  wet_data$time_minutes + 1440,
  wet_data$time_minutes
)

```
## We used the 100 m zones only for this model because we knew from the first model that the 100 m zones explained the data the best for each season. We set priors for this analysis using the average and maximum observed height of Bengal slow lorises in the tree from each season to create priors as we know that the lorises cannot exceed the maximum heights. 

## Dry Season Data Distribution

```{r Dryseason_datadistribution}

#plot height to determine distribution
hist(dry_data$animal_height.m.)
```
##Dry Season - Model

We set priors based on knowledge that we have about the environment (maximum tree height - 27.9m) and about mean (10.01 m) and median (9.6 m) height lorises were observed at during the dry season. 
```{r dryseasonmodel}
#set priors

priors <- c(
  prior(normal(10, 5), class = "Intercept"),
  prior(normal(0, 1), class = "b"), 
  prior(exponential(0.5), class = "sigma"), #this allows for variation in the extreme values
  prior(exponential(1), class = "sd")
)

# 100m zone
height_dry_model_100 <- brm(
  animal_height.m. ~ temp_c + temp_Rh_c + Rh_c + time_minutes + 
    (1 | zoneid_100m) + (1 | id), #these are the random effects 
  data = dry_data,
  family = gaussian(), #normally distributed continuous variable
  prior = priors,
  chains = 4,  #this is the recommended number from the model handbook 
  cores = 4,
  iter = 4000, #for stability
  control = list(adapt_delta = 0.99), # tighter adaptation (forces the model to be more careful),
  save_pars = save_pars(all = TRUE) #save all intermediate posterior draws so we can use moment matching later
)

pairs(height_dry_model_100) #let's you see if the parameters are correlated

plot(height_dry_model_100)
```

##Dry Season Bayesian R2 Value 

```{r dryseasonbayesianr2}
#Bayesian R2 value
bayes_R2(height_dry_model_100)

#Summarize the results
summary(height_dry_model_100)

```
##Hot Season

```{r hotseason_distribution}
#check distribution of the data
hist(hot_data$animal_height.m.)
```
```{r hotseason_model1}
#data is right skewed so let's test out which family will fit the data best
height_hot_model_100 <- brm(
  animal_height.m. ~ temp_c + temp_Rh_c + Rh_c + time_minutes + 
    (1 | zone_id_100) + (1 | id), #these are the random effects 
  data = hot_data,
  family = gaussian(), #normally distributed continuous variable
  chains = 4,  #this is the recommended number from the model handbook 
  cores = 4,
  iter = 4000, #for stability
  control = list(adapt_delta = 0.99), # tighter adaptation (forces the model to be more careful),
  save_pars = save_pars(all = TRUE)
)
```
## Hot Season Model 1 Distribution Check 

```{r hotseasonmodel1_distribution}
#Check fit of this distribution
pp_check(height_hot_model_100)
plot(height_hot_model_100)
```
## Hot Season Model 2 

Set new priors to see if these would deal with the variation in the data better (Loris height mean - 9.87 m, Loris height median - 9.8 m)
```{r hotseasonmodel2}
priors_hot <- c(
  prior(normal(10, 5), class = "Intercept"),
  prior(normal(0, 1), class = "b"), 
  prior(exponential(1), class = "sigma"),
  prior(exponential(1), class = "sd")
)

#new hot model
height_hot_model_100 <- brm(
  animal_height.m. ~ temp_c + temp_Rh_c + Rh_c + time_minutes + 
    (1 | zone_id_100) + (1 | id), #these are the random effects 
  data = hot_data,
  family = gaussian(), #normally distributed continuous variable
  prior = priors_hot, #set to match the mean height and max height of trees
  chains = 4,  #this is the recommended number from the model handbook 
  cores = 4,
  iter = 4000, #for stability
  control = list(adapt_delta = 0.99) # tighter adaptation (forces the model to be more careful),
)

pairs(height_hot_model_100)
```
## Hot Model 2 Distribution Check

```{r hotmodel2distribution}
#check fit
pp_check(height_hot_model_100)
plot(height_hot_model_100)
```
## Bayesian R2 Calculation and Model Summary

```{r HotSeasonBayesianR2}
#bayes R2
bayes_R2(height_hot_model_100)
#summarize

summary(height_hot_model_100)
```
## Wet Season

```{r wetseasondistribution}
#check distribution
hist(wet_data$animal_height.m.)
```
##Wet Season Priors 

Right skewed model with mean average loris height (9.3 m) and median loris height (8.9 m)
```{r wetseasonmodel}
# set new priors and go from there 
priors_wet <- c(
  prior(normal(10, 5), class = "Intercept"),
  prior(normal(0, 1), class = "b"), 
  prior(exponential(0.5), class = "sigma"),
  prior(exponential(1), class = "sd")
)

#data has a right skew so lets run a test model
height_wet_model_100 <- brm(
  animal_height.m. ~ temp_c + temp_Rh_c + Rh_c + time_minutes + 
    (1 | zoneid_100m) + (1 | id), #these are the random effects 
  data = wet_data,
  family = gaussian(), #normally distributed continuous variable
  prior = priors_wet,
  chains = 4,  #this is the recommended number from the model handbook 
  cores = 4,
  iter = 4000, #for stability
  control = list(adapt_delta = 0.99) # tighter adaptation (forces the model to be more careful),
)
```
## Wet Model Distribution

```{r wetmodeldistribution}
#check the fit
pp_check(height_wet_model_100)
plot(height_wet_model_100)
```
## Wet Model Bayesian R2

```{r - wetmodelbayesianr2}
#Bayes R2
bayes_R2(height_wet_model_100)

summary(height_wet_model_100)
```
##Figure Creation

```{r posteriors}
posterior_dryheight <- pp_check(height_dry_model_100, type = "dens_overlay", ndraws = 20) + ggtitle("Dry Season")
posterior_hotheight <- pp_check(height_hot_model_100, type = "dens_overlay", ndraws = 20) + ggtitle("Hot Season")
posteriot_wetheight <- pp_check(height_wet_model_100, type = "dens_overlay", ndraws = 20) + ggtitle("Wet Season")

#Let's put this in one grid
posterior_dryheight / posterior_hotheight / posteriot_wetheight
```

##Conditional Effects Calculation

##Dry season
```{r Dryseasonconditionaleffects}
ce_dry_h_temp <- conditional_effects(height_dry_model_100, effects = "temp_c")$temp_c
ce_dry_h_temp$predictor <- "Temperature (°C)"
ce_dry_h_temp$season <- "Dry"
names(ce_dry_h_temp)[1] <- "xval" #this sets the rows up to be called by ggplot
ce_dry_h_temp$x_actual <- ce_dry_h_temp$xval + 23.382838039 #back transforming the centered values

ce_dry_h_rh <- conditional_effects(height_dry_model_100, effects = "Rh_c")$Rh_c
ce_dry_h_rh$predictor <- "Relative Humidity (%)"
ce_dry_h_rh$season <- "Dry"
names(ce_dry_h_rh)[1] <- "xval"
ce_dry_h_rh$x_actual <- ce_dry_h_rh$xval + 73.19329866 #back transforming the centered values

ce_dry_h_time <- conditional_effects(height_dry_model_100, effects = "time_minutes")$time_minutes
ce_dry_h_time$predictor <- "Time of Day from 5pm (minutes)"
ce_dry_h_time$season <- "Dry"
names(ce_dry_h_time)[1] <- "xval"
ce_dry_h_time$x_actual <- ce_dry_h_time$xval #time in minutes was not centered so we do not need to back transform it
```
##Hot Season

```{r Hotseasonconditionaleffects}

ce_hot_h_temp <- conditional_effects(height_hot_model_100, effects = "temp_c")$temp_c
ce_hot_h_temp$predictor <- "Temperature (°C)"
ce_hot_h_temp$season <- "Hot"
names(ce_hot_h_temp)[1] <- "xval"
ce_hot_h_temp$x_actual <- ce_hot_h_temp$xval + 27.57769688 #mean temp value - we are back transforming

ce_hot_h_rh <- conditional_effects(height_hot_model_100, effects = "Rh_c")$Rh_c
ce_hot_h_rh$predictor <- "Relative Humidity (%)"
ce_hot_h_rh$season <- "Hot"
names(ce_hot_h_rh)[1] <- "xval"
ce_hot_h_rh$x_actual <- ce_hot_h_rh$xval + 66.44359584 #mean value to uncenter

ce_hot_h_time <- conditional_effects(height_hot_model_100, effects = "time_minutes")$time_minutes
ce_hot_h_time$predictor <- "Time of Day from 5pm (minutes)"
ce_hot_h_time$season <- "Hot"
names(ce_hot_h_time)[1] <- "xval"
ce_hot_h_time$x_actual <- ce_hot_h_time$xval
```
##Wet Season Conditional Effects Calculation

```{r wetseasonconditionaleffects}
ce_wet_h_temp <- conditional_effects(height_wet_model_100, effects = "temp_c")$temp_c
ce_wet_h_temp$predictor <- "Temperature (°C)"
ce_wet_h_temp$season <- "Wet"
names(ce_wet_h_temp)[1] <- "xval"
ce_wet_h_temp$x_actual <- ce_wet_h_temp$xval + 26.182844156 #mean value to back transform

ce_wet_h_rh <- conditional_effects(height_wet_model_100, effects = "Rh_c")$Rh_c
ce_wet_h_rh$predictor <- "Relative Humidity (%)"
ce_wet_h_rh$season <- "Wet"
names(ce_wet_h_rh)[1] <- "xval"
ce_wet_h_rh$x_actual <- ce_wet_h_rh$xval + 84.3028441560 #back transforming

ce_wet_h_time <- conditional_effects(height_wet_model_100, effects = "time_minutes")$time_minutes
ce_wet_h_time$predictor <- "Time of Day from 5pm (minutes)"
ce_wet_h_time$season <- "Wet"
names(ce_wet_h_time)[1] <- "xval"
ce_wet_h_time$x_actual <- ce_wet_h_time$xval
```
## One Data Frame - All Conditional Effects

```{r onedataframe}
all_ce_height <- bind_rows(
  ce_dry_h_temp, ce_dry_h_rh, ce_dry_h_time,
  ce_hot_h_temp, ce_hot_h_rh, ce_hot_h_time,
  ce_wet_h_temp, ce_wet_h_rh, ce_wet_h_time
)
```
##Figure Set Up

```{r Figuresetup}
season_colors <- c(
  "Hot" = "red",
  "Wet" = "blue", 
  "Dry" = "goldenrod"
)
#Let's make all the y-axis the same (we will use a global y-value)
yr <- range(all_ce_height$lower__, all_ce_height$upper__, na.rm = TRUE) #use upper and lower limits
pad <- diff(yr) * 0.03 #Pad the edges so that the graph is nice
global_y <- c(yr[1] - pad, yr[2] + pad)
#Now let's build individual facets
make_ce_plot <- function(df, predictor_name, x_label, y_limits = NULL) {
  ggplot(df %>% filter(predictor == predictor_name),
         aes(x = x_actual, y = estimate__, color = season, fill = season)) + 
    geom_line(linewidth = 1, show.legend = FALSE) + 
    geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.2, color = NA,
                show.legend = FALSE) +
    facet_wrap(~season, nrow = 1) + 
    labs(
      x = x_label,
      y = NULL #we will add the label to the full figure
    ) +
    scale_color_manual(values = season_colors, guide = "none") + 
    scale_fill_manual(values = season_colors, guide = "none") +
    scale_y_continuous(breaks = scales::pretty_breaks(n=4), expand = expansion(mult=0)) +
    coord_cartesian(ylim = y_limits) +
    theme_minimal(base_size = 13) + 
    theme(
      strip.text = element_text(face= "bold", size = 13),
      plot.title = element_text(face = "bold", size = 15, hjust = 0),
      axis.title.y = element_text(size = 11),
      axis.title.x = element_text(size = 12.5),
      legend = NA
    )
}
#Build the panels
p_temp <- make_ce_plot(all_ce_height, "Temperature (°C)", "Temperature (°C)", global_y)
p_rh <- make_ce_plot(all_ce_height, "Relative Humidity (%)", "Relative Humidity (%)", global_y)
p_time <- make_ce_plot(all_ce_height, "Time of Day from 7pm (minutes)", "Time of Day from 7pm (minutes)", global_y)
```

## One Figure
```{r onefigure, eval=TRUE, include = TRUE, cache = FALSE, fig.width =8, fig.height = 10}

#Now let's put them all in one figure
final_height_plot <- p_temp / p_rh / p_time + 
  plot_layout(guides = "collect") &
  theme(legend.position = "top")
print(final_height_plot)
```